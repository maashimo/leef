<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password | leef üçÉ</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .step-container {
      min-height: 300px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>

<body>
  <div class="auth-container">
    <div class="auth-card animate-scale" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 30px;">
        <a href="index.html" class="logo" style="justify-content: center; margin-bottom: 10px;">
          leef üçÉ
        </a>
        <h1>Reset Password</h1>
        <p style="color: var(--text-light);" id="stepDescription">Enter your email to receive a verification code</p>
      </div>

      <div id="successMessage" class="success-message"></div>
      <div id="errorMessage" class="error-message"></div>

      <div class="step-container">
        <!-- Step 1: Request OTP -->
        <div id="step1" class="step active">
          <form id="requestOtpForm">
            <div class="form-group">
              <label class="form-label">Email Address</label>
              <input type="email" name="email" id="emailInput" class="form-input" placeholder="e.g. john@example.com"
                required>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">
              Send Verification Code
            </button>
          </form>
        </div>

        <!-- Step 2: Enter OTP and New Password -->
        <div id="step2" class="step">
          <form id="resetPasswordForm">
            <div class="form-group">
              <label class="form-label">Verification Code</label>
              <input type="text" id="otpInput" class="form-input" placeholder="Enter 6-digit code" maxlength="6"
                pattern="\d{6}" inputmode="numeric" required>
              <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 5px;">
                Check your email for the verification code
              </p>
            </div>

            <div class="form-group">
              <label class="form-label">New Password</label>
              <input type="password" id="newPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
            </div>

            <div class="form-group">
              <label class="form-label">Confirm New Password</label>
              <input type="password" id="confirmPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6"
                required>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">
              Reset Password
            </button>

            <div style="text-align: center; margin-top: 15px;">
              <a href="#" id="backToStep1" style="color: var(--text-light); text-decoration: none; font-size: 0.9rem;">
                <i class="fas fa-arrow-left"></i> Back
              </a>
            </div>
          </form>
        </div>
      </div>

      <div style="text-align: center; margin-top: 30px;">
        <p style="color: var(--text-light); font-size: 0.9rem;">
          Remember your password? <a href="login.html" style="color: var(--primary-color); font-weight: 600;">Login</a>
        </p>
      </div>
    </div>
  </div>

  <script src="animations.js"></script>
  <script>
    let currentEmail = '';
    let currentRole = '';

    // Step 1: Request OTP
    document.getElementById('requestOtpForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('emailInput').value;

      currentEmail = email;
      // Role will be set by backend response

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      try {
        const res = await fetch('http://localhost:5000/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }) // Send only email
        });

        const data = await res.json();

        if (data.role) {
          currentRole = data.role; // Capture detected role for Step 2
        }

        if (!res.ok) {
          throw new Error(data.message || 'Failed to send code');
        }

        // Show success and move to step 2
        showSuccess('Verification code sent! Check your email.');
        setTimeout(() => {
          document.getElementById('step1').classList.remove('active');
          document.getElementById('step2').classList.add('active');
          document.getElementById('stepDescription').textContent = 'Enter the code and your new password';
          document.getElementById('otpInput').focus();
        }, 1500);

      } catch (err) {
        showError(err.message || 'Failed to send verification code');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Verification Code';
      }
    });

    // Step 2: Reset Password with OTP
    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const otpCode = document.getElementById('otpInput').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        showError('Passwords do not match');
        return;
      }

      if (newPassword.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Resetting Password...';

      try {
        const res = await fetch('http://localhost:5000/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentEmail,
            otpCode: otpCode,
            newPassword: newPassword,
            role: currentRole
          })
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText);
        }

        const data = await res.json();

        // Show success
        showSuccess(data.message || 'Password reset successfully!');

        // Redirect to login after 2 seconds
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);

      } catch (err) {
        showError(err.message || 'Failed to reset password');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Reset Password';
      }
    });

    // Back to step 1
    document.getElementById('backToStep1').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step1').classList.add('active');
      document.getElementById('stepDescription').textContent = 'Enter your email to receive a verification code';
      document.querySelector('#requestOtpForm button[type="submit"]').disabled = false;
      document.querySelector('#requestOtpForm button[type="submit"]').textContent = 'Send Verification Code';
    });

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = '‚úÖ ' + message;
      successDiv.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';

      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = '‚ùå ' + message;
      errorDiv.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }
  </script>
</body>

</html>