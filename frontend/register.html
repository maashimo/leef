<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register | leef üçÉ</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Password Strength Styles */
    .password-strength-container {
      margin-top: 5px;
    }

    .strength-meter-bg {
      height: 4px;
      background: #333;
      /* Dark background for the track */
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .strength-meter-fill {
      height: 100%;
      width: 0;
      transition: width 0.3s ease, background-color 0.3s ease;
      border-radius: 2px;
    }

    .password-feedback {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .strength-weak {
      background-color: #ef4444;
    }

    .strength-medium {
      background-color: #eab308;
    }

    .strength-strong {
      background-color: #22c55e;
    }
  </style>
</head>

<body>

  <div class="auth-container">
    <div class="auth-card animate-scale" style="max-width: 600px;">
      <div style="text-align: center; margin-bottom: 30px;">
        <a href="index.html" class="logo" style="justify-content: center; margin-bottom: 10px;">
          leef üçÉ
        </a>
        <h1>Create Account</h1>
        <p style="color: var(--text-light);">Join the community and start your fresh journey</p>
      </div>

      <form action="http://localhost:5000/api/auth/register" method="post" enctype="multipart/form-data"
        class="register-form">
        <!-- Full Name -->
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" name="fullname" placeholder="e.g. Nimal Perera" required>
        </div>

        <!-- Username -->
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" name="username" placeholder="e.g. nimal_99"
            style="text-transform: lowercase;">
        </div>

        <!-- Email -->
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" name="email" placeholder="e.g. niaml@example.com" required>
        </div>

        <!-- Password -->
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" name="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          <div class="password-strength-container" id="strengthContainer" style="display:none;">
            <div class="strength-meter-bg">
              <div class="strength-meter-fill" id="strengthMeter"></div>
            </div>
            <div class="password-feedback" id="passwordFeedback"></div>
          </div>
        </div>

        <!-- Address -->
        <div class="form-group">
          <label class="form-label">Address</label>
          <input type="text" class="form-input" name="address" placeholder="Your delivery address" required>
        </div>

        <!-- Role (Hidden, always customer) -->
        <input type="hidden" name="role" value="customer">

        <!-- Customer Town -->
        <div class="form-group" id="customer-town-container">
          <label class="form-label">Select Your Town</label>
          <select name="town" id="customerTown" class="form-input" required>
            <option value="" disabled selected>Select Your Town</option>
            <option>Colombo</option>
            <option>Kandy</option>
            <option>Galle</option>
            <option>Kurunegala</option>
            <option>Matara</option>
            <option>Nuwara Eliya</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
          Send Request
        </button>

        <p style="text-align: center; margin-top: 20px; color: var(--text-light);">
          Already have an account?
          <a href="login.html" style="color: var(--primary-color); font-weight: 600;">Login</a>
        </p>
      </form>
    </div>
  </div>

  <script src="animations.js"></script>
  <script>
    // Password Strength Logic
    const passwordInput = document.getElementById('passwordInput');
    const strengthContainer = document.getElementById('strengthContainer');
    const strengthMeter = document.getElementById('strengthMeter');
    const passwordFeedback = document.getElementById('passwordFeedback');
    let isPasswordValid = false;

    passwordInput.addEventListener('input', function () {
      const password = this.value;
      strengthContainer.style.display = 'block';

      const hasMinLength = password.length >= 6;
      const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

      // Calculate basic score
      let score = 0;
      if (hasMinLength) score++;
      if (hasSpecialChar) score++;
      if (password.length >= 10) score++;

      // UI Update
      strengthMeter.className = 'strength-meter-fill'; // reset

      if (password.length === 0) {
        strengthMeter.style.width = '0%';
        passwordFeedback.textContent = '';
        isPasswordValid = false;
        return;
      }

      if (!hasMinLength) {
        strengthMeter.style.width = '33%';
        strengthMeter.classList.add('strength-weak');
        passwordFeedback.textContent = 'Too short (min 6 chars)';
        passwordFeedback.style.color = '#ef4444';
        isPasswordValid = false;
      } else if (!hasSpecialChar) {
        strengthMeter.style.width = '66%';
        strengthMeter.classList.add('strength-medium');
        passwordFeedback.textContent = 'Add a special character';
        passwordFeedback.style.color = '#eab308';
        isPasswordValid = false;
      } else {
        strengthMeter.style.width = '100%';
        strengthMeter.classList.add('strength-strong');
        passwordFeedback.textContent = 'Strong password';
        passwordFeedback.style.color = '#22c55e';
        isPasswordValid = true;
      }
    });

    document.querySelector('.register-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!isPasswordValid) {
        // Fallback validation check just in case user pasted or autofilled without triggering input perfectly
        const password = passwordInput.value;
        const hasMinLength = password.length >= 6;
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasMinLength || !hasSpecialChar) {
          alert("Password must be at least 6 characters long and include a special character.");
          passwordInput.focus();
          return;
        }
      }

      const formData = new FormData(e.target);
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;

      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating Account...';

      try {
        const res = await fetch('http://localhost:5000/api/auth/register', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert(errorText);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        const data = await res.json();

        // Redirect to verification page with email and role
        window.location.href = `verify-email.html?email=${encodeURIComponent(data.email)}&role=${data.role}`;

      } catch (err) {
        alert('Cannot connect to backend üò¢. Is the server running?');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  </script>
</body>

</html>